# TCP/IP 와 UDP

## TCP/IP
TCP/IP는 패킷 통신 방식의 인터넷 프로토콜인 IP와 전송 조절 프로토콜인 TCP로 이루어져 있다.<br>
IP는 패킷 전달 여부를 보증하지 않고, 패킷을 보낸 순서와 받는 순서가 다를 수 있다.<br>
TCP는 IP위에서 동작하는 프로토콜로 데이터의 전달을 보증하고 보낸 순서대로 받게 해준다.<br>
HTTP, FTP, SMTP 등 TCP를 기반으로 한 많은 수의 어플리케이션 프로토콜들이 IP 위에서 동작하기 때문에 묶어서 TCP/IP라고 부르기도 한다.<br><br>
TCP/IP는 패킷 통신을 위한 인터넷의 규약이다. IP는 데이터의 조각들을 최대한 빨리 목적지로 보내는 역할을 한다.<br>
조각들의 순서가 뒤바뀌거나 일부가 누락되더라도 크게 상관하지 않고 보내는데 집중한다.<br>
TCP는 IP보다 느리지만 도착한 조각의 순서를 확인하고 빠진 조각을 다시 요청한다.<br>

### 패킷통신
데이터를 전송할때 내용을 작게 잘라서 보내는 방법이다<br>
잘게 잘라진 조각들은 다중화된 망을 통해 각각 목적지를 향해 가장 효율적인 방법으로 이동한다.<br><br>
내용을 잘게 잘라 보내다보면 뒤섞이거나 빠진 내용이 생길 수 있다.<br>
목적지에서 점검을 해서 순서대로 정렬을 하고 빠지거나 잘못된 부분이 있으면 잘못된 부분만 다시 받아 합친다.
<br>
패킷통신을 통해 하나의 회선에서도 여러 명이 동시에 통신을 할 수 있다.

### TCP 특징
- 연결형 서비스로 가상 회선 방식을 제공한다.
- 3 way handshaking 과정을 통해 연결을 설정하고 4 way handshaking을 통해 해제한다.
- 흐름 제어 및 혼잡 제어
- 높은 신뢰성을 보장한다.
- udp보다 속도가 느리다.
- 전이중(Full-Duplex), 점대점(Point to Point) 방식
- 연속성보다 신뢰성 있는 전송이 중요할 때에 사용하는 프로토콜이다.

### TCP 서버의 특징
- 서버소켓은 연결만을 담당한다.
- 연결과정에서 반환된 클라이언트 소켓은 데이터의 송수신에 사용된다.
- 서버와 클라이언트는 1대1로 연결된다.
- 스트림 전송으로 전송 데이터의 크기가 무제한이다.
- 패킷에 대한 응답을 해야하기 때문에 시간지연, CPU소모로 인해 성능이 낮다.
- Streaming 서비스에 불리하다. (손실된 경우 재전송 요청)

### 3 way handshake 방식 (SYN, ACK)
TCP 통신을 위한 네트워크 연결 방식이다.<br>
서로의 통신을 위한 관문(port)를 확인하고 연결하기 위하여 3번의 요청과 응답을 주고 받은 후에 연결이 된다.<br>
이 과정에서 가장 많은 시간이 소요되며 UDP 방식보다 속도가 느려지는 주요 원인으로 지목된다.<br><br>

<b>연결과정</b>

- 클라이언트에서 서버에 연결요청을 하기 위해 SYN 데이터를 보낸다.
- 서버의 해당 포트는 LISTEN 상태에서 SYN 데이터를 받고 SYN_RCV 상태가 된다.
- 요청을 정상적으로 받았다는 대답(ACK)와 클라이언트도 포트를 열어달라는 SYN을 같이 보낸다.
- 클라이언트는 SYN + ACK를 받고 ESTABLISHED로 상태를 변경하고 서버에 ACK를 전송한다.
- ACK를 받은 서버는 상태가 ESTABLISHED로 변경된다.

### TCP state

- LISTEN: 서버의 데몬이 떠서 접속 요청을 기다리는 상태
- SYN_SENT: 로컬의 클라이언트 어플리케이션이 원격 호스트에 연결을 요청한 상태
- SYN_RECEIVED: 서버가 원격 클라이언트로부터 접속 요구를 받아 클라이언트에게 응답을
- ESTABLISHED: 3 way handshaking이 완료된 후 서로 연결된 상태
- FIN-WAIT1, CLOSE-WAIT, FIN-WAIT2: 서버에서 연결을 종료하기 위해 클라이언트에게 종결을 요청하고 회신을 받아 종료하는 과정의 상태
- TIME-WAIT: 연결은 종료되었지만 분실되었을지 모를 느린 세그먼트를 위해 당분간 소켓을 열어두고 있는 상태
- CLOSING: 흔하지 않지만 주로 확인 메시지가 전송도중 분실된 상태
- CLOSED: 완전히 종료

### TCP 헤더 정보
필드 | 크기 | 내용
|----------|-------|---------------|
송수신자의 포트 번호 | 16 | TCP로 연결되는 가상 회선 양단의 송수신 프로세스에 할당되는 포트 주소
시퀀스 번호 (Sequence Number)| 32 |송신자가 지정하는 순서 번호, 전송되는 바이트 수를 기준으로 증가
응답번호 (ACK Number) | 32 | 수신 프로세스가 제대로 수신한 바이트 수를 응답하기 위해 사용
데이터 오프셋 (Data Offset) | 4 | TCP 세그먼트의 시작 위치를 기준으로 데이터의 시작 위치를 표현
예약 필드 (Reserved) | 6 | 사용 하지 않지만 나중을 위한 예약 필드이며 0으로 채워져야 한다.
제어비트 (Flag Bit) | 6 | SYN, ACK, FIN 등의 제어 번호
윈도우 크기 (Window) | 16 | 수신 윈도우의 버퍼 크기를 지정할 때 사용, 0이면 송신 프로세스의 전송 중지
체크섬 (Checksum) | 16 | TCP 세그먼트에 포함되는 프로토콜 헤더와 데이터에 대한 오류 검출 용도
긴급 위치 (Urgent Pointer) | 16 | 긴급 데이터를 처리하기 위함, URG 플래그 비트가 지정된 경우에만 유효

### TCP 제어 비트 (Flag Bit 정보)
종류 | 내용
|---|---------|
ACK | 응답 번호 필드가 유효한지 설정할때 사용, 상대방으로부터 패킷을 받았다는 걸 알려준다. 클라이언트가 보낸 최초의 SYN 패킷 이후 전송되는 모든 패킷은 이 플래그가 설정되어야 한다.
SYN | 연결 설정 도구. 동기화 시퀀스 번호. 양쪽이 보낸 최초의 패킷에만 이 플래그가 설정되어 있어야 한다. TCP에서 세션을 성립할 때 가장 먼저 보내는 패킷, 시퀀스 번호를 임의적으로 설정하여 세션을 연결하는데 사용되며 초기에 시퀀스 번호를 보내게 된다.
PSH | 수신 어플리케이션에 버퍼링된 데이터를 상위 계층에 즉시 전달할 때 사용된다.
RST | 연결의 리셋이나 유효하지 않은 세그먼트에 대한 응답용으로 사용된다.
URG | 긴급 위치 필드가 유효한지 설정
FIN | 세션 연결을 종료시킬 때 사용되며 더 이상 전송할 데이터가 없을 때 연결 종료 의사 표시

## UDP (User Datagram Protocol)
데이터를 데이터그램 단위로 처리하는 프로토콜
<br><br>
데이터그램이란 독립적 관계를 지니는 패킷이라는 뜻이다<br>
TCP와 달리 UDP는 비연결형 프로토콜이다.<br>
즉, 연결을 위해 할당되는 논리적인 경로가 없기 때문에 각각의 패킷은 다른 경로로 전송되고 독립적 관계를 지닌다.<br>
이렇게 데이터를 서로 다른 경로로 독립적으로 처리하는 프로토콜을 UDP라고 한다.

### 특징
- 비연결형 서비스로 데이터그램 방식을 제공한다.
- 정보를 주고 받을 때 정보를 보내거나 받는다는 신호절차를 거치지 않는다.
- UDP헤더의 CheckSum 필드를 통해 최소한의 오류만 검출한다.
- 신뢰성이 낮다.
- TCP보다 속도가 빠르다.

UDP는 비연결형 서비스이기 때문에 연결을 설정하고 해제하는 과정이 존재하지 않는다.<br>
서로 다른 경로로 독립적으로 처리함에도 패킷의 순서대로 재조립하거나 흐름제어 또는 혼잡제어와 같은 기능도 처리하지 않아 TCP보다 속도가 빠르며 네트워크 부하가 적다는 장점이 있지만 신뢰성 있는 데이터의 전송을 보장하지 못한다.<br>
그렇기 때문에 신뢰성보다는 연속성이 중요한 서비스에 주로 사용된다.

### UDP 서버의 특징
- UDP에는 연결 자체가 없어서 서버 소켓과 클라이언트 소켓의 구분이 없다.
- 소켓 대신 IP를 기반으로 데이터를 전송한다.
- 서버와 클라이언트는 1대1, 1대N, N대M 등으로 연결될 수 있따.
- 데이터그램 단위로 전송되며 크기는 65535바이트로 크기가 초괴되면 잘라서 보낸다.
- 흐름제어가 없어서 패킷이 제대로 전송되었는지, 오류가 없는지 확인할 수 없다.
- 파일 전송과 같은 신뢰성이 필요한 서비스보다 성능이 중요시 되는 경우에 사용된다(Streaming 서비스)

### 흐름제어와 혼잡제어란 ?
흐름제어는 데이터를 송신하는 곳과 수신하는 곳의 데이터 처리속도를 조절하여 수신자의 버퍼 오버플로우를 방지한다.<br>
예를 들어 송신하는 곳에서 수신하는 곳이 감당이 안되게 데이터를 빠르게 많이 보내면 수신자 쪽에 문제가 발생하기 때문에 흐름제어가 필요하다<br>
혼잡제어는 네트워크 내의 패킷 수가 넘치지 않도록 방지한다<br>

## TCP와 UDP의 비교
|  | TCP | UDP |
|-----|------|-----|
연결방식 | 연결형 서비스 | 비연결형 서비스
패킷 교환 방식 | 가상 회선 방식 | 데이터그램 방식
전송 순서 | 전송 순서 보장 | 전송 순서가 바뀔 수 있음
수신 여부 확인 | 수신 여부를 확인함 | 수신 여부를 확인하지 않음
통신 방식 | 1:1 통신 | 1:1 또는 1:N 또는 N:M
신뢰성 | 높다 | 낮다
속도 | 느리다 | 빠르다